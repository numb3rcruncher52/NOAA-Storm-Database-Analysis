---
title: "NOAA-Storm-Analysis"
author: "Max Lyons"
date: "July 9, 2016"
output: html_document
---

## Synopsis
This is an analysis of the U.S. National Oceanic and Atmospheric 
Administration's (NOAA) storm database for the reproducible research course
on Coursera. The goal of the analysis is to determine which types of storm 
events have the greatest impact on 1) population health and 2) the economy
across the U.S.


## Data Processing
The first step in our analysis is pulling the data from the Coursera website,
storing it in a dataframe, and caching the result since it's a moderately
large dataset:
```{r, cache=TRUE}
library(dplyr)
library(ggplot2)
data_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
download.file(data_url,"NOAAdata.csv.bz2", method="curl")
storms <- read.csv("NOAAdata.csv.bz2",stringsAsFactors = FALSE)
```
Let's quickly check the structure of the dataset to see what fields are 
available and compare to the online information about the storm database.
```{r}
str(storms)
```
The dataset appears to have information about a few major categories: location,
time span, fatalities/injuries, and damage. Since we know that we want to 
identify the types of events that have the biggest impact on population health 
and the economy, we will focus on the fatalities/injuries, damage, and event
type data.
```{r}
storms2 <- storms %>% select(EVTYPE, FATALITIES, INJURIES, PROPDMG:CROPDMGEXP, REMARKS)
```
Let's look at each of our fields to see what kind of preprocessing we may need
to do:
### EVTYPE
```{r}
storm_types <- storms2 %>% count(EVTYPE) %>% arrange(-n)
storm_types
summary(storm_types$n)
```
We can see that there are 985 different labels for storms, and looking at the
summary of the counts for each type, at least 75% of the labels have occurences
of 5 or less. We will need to go through and clean up some of the labels, but
let's see if we can reduce the total number of labels by focusing on the types
of storms that effect population health or the economy.
### FATALITIES & INJURIES: Population Health
According to the National Weather Service Documentation, Direct fatalities and
injuries from storms are classified in the FATALITIES and INJURIES columns. We 
will use these columns without any additional processing to evaluate population
health.
### Economy
There are four fields that are utilized to provide information about the 
economic impact of the storms: PROPDMG, PROPDMGEXP, CROPDMG, and CROPDMGEXP.
Both PROPDMG and CROPDMG list the damage amounts for property and crops, 
respectively, and the other two columns give a unit of measure. We will need to
combine the values and unit of measure columns to compare damage across all 
storms. Let's check out the different units of measure:
```{r}
table(storms2$PROPDMGEXP)
table(storms2$CROPDMGEXP)
```
From these tables we can see units of measure for thousands (k/K), 
millions (M/m), and billions (B/b). I will also assume that (h/H) is hundreds, 
and we will have to investigate the (?) and the single numbers:
```{r}
check_uom <- c('?','+','-','0','1','2','3','4','5','6','7','8')
questions <- storms2 %>% filter((PROPDMGEXP %in% check_uom) | 
                                    (CROPDMGEXP %in% check_uom))
```
After looking into all the strange units of measure it appears that there isn't
any specific pattern to having a number as the unit of measure, but there are 
multiple instances in the Remarks that mentions damage of some kind. Since the 
most common unit of measure by far is thousands, I will simply replace any of 
these strange units of measure with thousands.
```{r}
storms_clean <- storms2 %>% 
    mutate(PROPDMGEXP = ifelse(PROPDMGEXP %in% check_uom, 'K', 
                               toupper(PROPDMGEXP)), 
           CROPDMGEXP = ifelse(CROPDMGEXP %in% check_uom, 'K', 
                               toupper(CROPDMGEXP)))
## Replace the units of measure with numbers
clean_uom <- data.frame(old_uom = c('H','K','M','B',''), 
                        new_uom = c(100,1000,1000000,1000000000,0))
storms_clean <- storms_clean %>% left_join(clean_uom, 
                                           by = c('PROPDMGEXP' = 'old_uom'))
storms_clean <- storms_clean %>% left_join(clean_uom, 
                                           by = c('CROPDMGEXP' = 'old_uom'))
storms_clean <- storms_clean %>% mutate(TOTDMG = PROPDMG * new_uom.x + 
                                            CROPDMG * new_uom.y)
storms_final <- storms_clean %>% select(EVTYPE, FATALITIES, INJURIES, TOTDMG)
head(storms_final)
```
Now that we have clean measures of damage, injuries, and fatalities, all that
is left to do is clean the EVTYPE for analysis. Let's examine only the EVTYPEs
that have had damage, fatalities, or injuries:
```{r}
storm_types_new <- storms_final %>% 
    filter((FATALITIES > 0) | (INJURIES > 0) | (TOTDMG > 0)) %>%
    count(EVTYPE) %>% arrange(-n)
storm_types_new
summary(storm_types_new$n)
```
There are now only half as many storm categorizations, but we can make a few
clean ups to try and consolidate them even more:
```{r}
storms_final$EVTYPE_NEW <- gsub("TSTM ","THUNDERSTORM ",storms_final$EVTYPE)
storms_final$EVTYPE_NEW <- gsub("WINDS","WIND",storms_final$EVTYPE_NEW)
storms_final$EVTYPE_NEW <- toupper(storms_final$EVTYPE_NEW)
```
There are many more cleanups that could be done, but if we also filter out
all the storms that have less than 100 occurrences, we will have a much more 
clean data set.
```{r}
storm_types_new <- storms_final %>% 
    filter((FATALITIES > 0) | (INJURIES > 0) | (TOTDMG > 0)) %>%
    count(EVTYPE_NEW) %>% filter(n >= 100)
storms_final2 <- storms_final %>% 
    filter(EVTYPE_NEW %in% storm_types_new$EVTYPE_NEW)
perc_remain <- nrow(storms_final2)/nrow(storms_final)*100
```
We lost some of the original data but still have `r perc_remain`% of the
original data good for analysis.

## Results

### Analysis of Economic Impact
To analyze the effect on the economy of the different storm types we can 
calculate some different summary statistics by storm like mean, median, and
maximum:
```{r}
average_damage <- storms_final2 %>% group_by(EVTYPE_NEW) %>% 
    summarise(n = n(), AVG_DMG = mean(TOTDMG), MED_DMG = median(TOTDMG), 
              MAX_DMG = max(TOTDMG)) %>%
    arrange(-AVG_DMG) %>% top_n(5,wt = AVG_DMG)
```
We can then plot some box-and-whisker plots for the top 5 storm types by 
average total damage to make our best inference on which storm type impacts
the economy most:


```{r}
summary(storms$FATALITIES)
summary(storms$INJURIES)
```
From basic summaries of the data, we can tell that most storms don't cause a 
single injury or fatality, as the median of both columns is 0. Let's figure out
what percentage of storms have at least one injury or fatality, and then look at
a summary of that subset of data
```{r}
sum(storms$FATALITIES[storms$FATALITIES >= 1])/nrow(storms)*100
sum(storms$INJURIES[storms$INJURIES >= 1])/nrow(storms)*100
```


